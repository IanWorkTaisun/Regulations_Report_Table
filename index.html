<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>法規公告可視化</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; font-family: Microsoft JhengHei; background: #f5f5f5; }
        .block-card { background: #fff; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 2px 12px #0001;}
        .block-header { padding: 16px 20px; border-bottom: 1px solid #eee; background: #f3f8fa;}
        .block-title { font-size: 1.2rem; font-weight: bold; color: #007b83;}
        .block-count { color: #888; font-size: 0.95em; margin-left: 8px; }
        .search-box { margin-bottom: 30px; }
        .table th, .table td { vertical-align: middle; }
        .sortable:hover { color: #2c6db3; cursor: pointer; text-decoration: underline; }
        .arrow { font-size: 0.8em; }
        .more-btn { background: #f7f7f7; color: #007b83; border: 1px solid #eee; border-radius: 5px; padding: 4px 14px; margin: 0 0 14px 0; }
        .pie-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 12px;}
        .pie-links a { padding: 4px 8px; background: #f4f8fc; border-radius: 4px; font-size: 0.95em; color: #0066cc; text-decoration: none;}
        .pie-links a:hover { background: #d6e6f8;}
    </style>
</head>
<body>
<div id="app">
    <h1 class="mb-3">法規公告看板</h1>
    <div class="search-box">
        <input v-model="searchText" type="text" class="form-control" placeholder="輸入標題或內容關鍵字...">
    </div>

    <!-- 主分布圖（各類型數量） -->
    <div class="card mb-4" style="max-width:700px;margin:auto;">
        <div class="card-body">
            <h5 class="card-title">各類型公告分布</h5>
            <canvas id="mainTypeChart"></canvas>
            <div class="pie-links">
                <a v-for="type in pieTypes" :href="'#block_' + type" :key="type">{{ type }}</a>
            </div>
        </div>
    </div>

    <template v-if="grouped.length">
        <div v-for="(block, idx) in grouped" :key="block.type" :id="'block_' + block.type" class="block-card">
            <div class="block-header d-flex align-items-center justify-content-between">
                <span class="block-title">{{ block.type }}</span>
                <span class="block-count">共 {{ block.items.length }} 筆</span>
            </div>
            <div class="p-3 pb-2">
                <!-- 小時序圖：折線+數值 -->
                <div style="max-width:380px;margin-bottom:12px;">
                    <canvas :id="'typeTrend_' + idx"></canvas>
                </div>
                <table class="table table-sm table-hover align-middle mb-0">
                    <thead>
                    <tr>
                        <th @click="sortBy('date')" class="sortable">
                            日期
                            <span v-if="sortField==='date'">
                                <span v-if="sortDirection==='asc'" class="arrow">&#9650;</span>
                                <span v-else class="arrow">&#9660;</span>
                            </span>
                        </th>
                        <th @click="sortBy('title')" class="sortable">
                            標題
                            <span v-if="sortField==='title'">
                                <span v-if="sortDirection==='asc'" class="arrow">&#9650;</span>
                                <span v-else class="arrow">&#9660;</span>
                            </span>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 只顯示最新日期資料 -->
                    <tr v-for="item in showItems(block)" :key="item.url">
                        <td>{{ formatDate(item.date) }}</td>
                        <td><a :href="item.url" target="_blank">{{ item.title }}</a></td>
                    </tr>
                    </tbody>
                </table>
                <div v-if="block.items.length > showItems(block).length">
                    <button class="more-btn" @click="toggleMore(idx)">
                        {{ moreOpen[idx] ? "收起" : "更多..." }}
                    </button>
                </div>
            </div>
        </div>
    </template>
    <div v-else class="text-center mt-5 text-secondary fs-4">今日無新增法規公告</div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const regulations = ref([]);
        const searchText = ref('');
        const sortField = ref('date');
        const sortDirection = ref('desc');
        const moreOpen = ref({});
        const pieTypes = ref([]);

        // 日期格式化
        function formatDate(date) {
            if (!date) return '未提供';
            if (typeof date === "number" && date > 1e12) {
                const d = new Date(date);
                return d.toISOString().slice(0, 10);
            }
            if (typeof date === "string") {
                if (/^\d{13}$/.test(date)) {
                    const d = new Date(Number(date));
                    return d.toISOString().slice(0, 10);
                }
                return date.slice(0, 10);
            }
            return '未提供';
        }

        // 載入 JSON（已改成你的 Apps Script API 網址）
        async function loadData() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwH74JqBJa7gVK-QvBeZjeSaTZCrjAcMerveHxGV28fy_ERqqv3T-6UO9od-Mn86s1O/exec');
                const data = await response.json();
                regulations.value = data;
                setTimeout(drawMainTypeChart, 100);
            } catch (error) {
                console.error('載入數據失敗:', error);
            }
        }

        // 搜尋 & 排序
        const filteredRegulations = computed(() => {
            let items = [...regulations.value];
            if (searchText.value) {
                const keyword = searchText.value.toLowerCase();
                items = items.filter(item =>
                    (item.title || '').toLowerCase().includes(keyword) ||
                    (item.announcement_type || '').toLowerCase().includes(keyword)
                );
            }
            items.sort((a, b) => {
                const valA = a[sortField.value] || '';
                const valB = b[sortField.value] || '';
                return sortDirection.value === 'asc'
                    ? valA.toString().localeCompare(valB.toString())
                    : valB.toString().localeCompare(valA.toString());
            });
            return items;
        });

        // 分群（不同類型不同 block）
        const grouped = computed(() => {
            const groupMap = {};
            filteredRegulations.value.forEach(item => {
                const type = item.announcement_type || '未分類';
                if (!groupMap[type]) groupMap[type] = [];
                groupMap[type].push(item);
            });
            // 把所有類型傳給 pieTypes 給圓餅圖下方做 anchor
            pieTypes.value = Object.keys(groupMap);
            return Object.keys(groupMap).sort().map(type => ({
                type,
                items: groupMap[type]
            }));
        });

        // 每個區塊只顯示最新日期的資料，其餘按 more/收起 控制
        function showItems(block) {
            if (moreOpen.value[block.type]) return block.items;
            const dates = block.items.map(i => formatDate(i.date));
            const maxDate = dates.sort().reverse()[0];
            return block.items.filter(i => formatDate(i.date) === maxDate);
        }
        function toggleMore(idx) {
            moreOpen.value[grouped.value[idx].type] = !moreOpen.value[grouped.value[idx].type];
            setTimeout(() => drawTypeTrend(idx, grouped.value[idx].items), 50);
        }

        // 圓餅圖（含占比/名稱/件數 label）
        function drawMainTypeChart() {
            if (!window.Chart) return;
            const typeMap = {};
            regulations.value.forEach(i => {
                if (i.announcement_type) {
                    typeMap[i.announcement_type] = (typeMap[i.announcement_type] || 0) + 1;
                }
            });
            if (window.mainChart) window.mainChart.destroy();
            const total = Object.values(typeMap).reduce((a, b) => a + b, 0);
            window.mainChart = new Chart(document.getElementById('mainTypeChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(typeMap),
                    datasets: [{
                        data: Object.values(typeMap),
                        backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#00897B']
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#333',
                            font: { weight: 'bold', size:14 },
                            formatter: function(val, ctx) {
                                const label = ctx.chart.data.labels[ctx.dataIndex];
                                const percent = total ? Math.round(val / total * 100) : 0;
                                return `${label}\n${percent}%（${val}件）`;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            setTimeout(drawAllTypeTrends, 10);
        }

        // 折線圖（小型時序圖，顯示每個點數值）
        function drawTypeTrend(idx, items) {
            const ctx = document.getElementById('typeTrend_' + idx);
            if (!ctx) return;
            if (ctx._chart) { ctx._chart.destroy(); }
            const dateMap = {};
            items.forEach(i => {
                const d = formatDate(i.date);
                dateMap[d] = (dateMap[d] || 0) + 1;
            });
            const dates = Object.keys(dateMap).sort();
            ctx._chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '每日公告數',
                        data: dates.map(d => dateMap[d]),
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54,162,235,0.1)',
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#36A2EB',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6,
                        tension: 0.3
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            font: { size:12, weight:'bold' },
                            formatter: function(value) { return value; }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { precision:0 } }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        function drawAllTypeTrends() {
            grouped.value.forEach((block, idx) => drawTypeTrend(idx, block.items));
        }

        function sortBy(field) {
            if (sortField.value === field) {
                sortDirection.value = sortDirection.value === 'asc' ? 'desc' : 'asc';
            } else {
                sortField.value = field;
                sortDirection.value = 'asc';
            }
        }

        onMounted(loadData);

        return {
            regulations,
            searchText,
            filteredRegulations,
            grouped,
            sortBy,
            sortField,
            sortDirection,
            formatDate,
            showItems,
            moreOpen,
            toggleMore,
            pieTypes
        };
    }
}).mount('#app');
</script>
</body>
</html>
